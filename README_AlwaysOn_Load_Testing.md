# AlwaysOn Availability Group Load Generation Guide

## üìã Quick Start Instructions

### Prerequisites
1. **SQL Server with Always On AG configured**
2. **Primary and Secondary replicas online**
3. **Appropriate permissions** to create databases and run queries

### Step-by-Step Execution

#### 1. Set Up Test Database
```sql
-- Run this first on PRIMARY replica
-- File: 1_setup_alwayson_database.sql
```

#### 2. Add Database to Availability Group
```sql
-- On PRIMARY replica:
ALTER AVAILABILITY GROUP [YourAGName] ADD DATABASE [AlwaysOnLoadTest];

-- On SECONDARY replica(s):
-- Restore database from backup (if needed)
ALTER DATABASE [AlwaysOnLoadTest] SET HADR AVAILABILITY GROUP = [YourAGName];
```

#### 3. Run Workloads (Open Multiple Query Windows)
Execute these files **simultaneously** in separate query windows:

| File | Purpose | Expected Impact |
|------|---------|-----------------|
| `2_workload_high_volume_transactions.sql` | Generate large log volume | ‚Üë Log bytes received/sec |
| `3_workload_frequent_updates.sql` | Create redo queue pressure | ‚Üë Redo queue size |
| `4_workload_bulk_operations.sql` | Stress log send mechanisms | ‚Üë Log send queue |
| `5_workload_mixed_operations.sql` | Trigger flow control | ‚Üë Flow control time |

#### 4. Monitor Metrics
```sql
-- Run this periodically in another query window
-- File: 6_monitor_alwayson_metrics.sql
```

#### 5. Check OpenTelemetry Collector Output
Monitor for these metrics:
- `sqlserver.failover_cluster.log_bytes_received_per_sec`
- `sqlserver.failover_cluster.transaction_delay_ms`
- `sqlserver.failover_cluster.flow_control_time_ms`
- `sqlserver.failover_cluster.log_send_queue_kb`
- `sqlserver.failover_cluster.redo_queue_kb`
- `sqlserver.failover_cluster.redo_rate_kb_sec`

## üîß PowerShell Automation (Windows)
```powershell
# Run automated load test
.\Run-AlwaysOnLoadTest.ps1 -ServerInstance "YourServer" -DatabaseName "AlwaysOnLoadTest" -DurationMinutes 30
```

## üêß Bash Automation (Linux/macOS)
```bash
# Run automated load test
./run_alwayson_load_test.sh YourServer AlwaysOnLoadTest 30
```

## üéØ Expected Results

### Normal Load Conditions
- Log bytes received/sec: 1,000-10,000 bytes/sec
- Transaction delay: <5ms
- Flow control time: 0ms/sec
- Log send queue: <100KB
- Redo queue: <50KB
- Redo rate: 100-1,000KB/sec

### High Load Conditions (During Test)
- Log bytes received/sec: **50,000-500,000 bytes/sec**
- Transaction delay: **10-100ms**
- Flow control time: **>0ms/sec**
- Log send queue: **500KB-5MB**
- Redo queue: **200KB-2MB**
- Redo rate: **1,000-10,000KB/sec**

## üö® Important Notes

### Safety
- **Test Environment Only**: Don't run on production systems
- **Resource Intensive**: Monitor CPU, memory, and disk usage
- **Network Impact**: High network traffic between replicas

### Troubleshooting
- **Zero Metrics**: Check if AG is properly configured and synchronized
- **High CPU**: Reduce iteration counts in workload scripts
- **Lock Timeouts**: Normal during heavy load testing
- **Disk Space**: Monitor transaction log growth

### Cleanup
```sql
-- After testing (on PRIMARY)
USE master;
ALTER AVAILABILITY GROUP [YourAGName] REMOVE DATABASE [AlwaysOnLoadTest];
DROP DATABASE AlwaysOnLoadTest;
```

## üìä Metric Explanations

| Metric | What It Measures | Why It's Important |
|--------|------------------|-------------------|
| **Log Bytes Received/sec** | Rate of log data flowing from primary to secondary | Indicates replication throughput |
| **Transaction Delay** | Processing delay on secondary replica | Shows replication lag impact |
| **Flow Control Time** | Time spent throttling log send rate | Indicates when secondary can't keep up |
| **Log Send Queue** | Backlog of log data waiting to be sent | Shows primary-side bottlenecks |
| **Redo Queue** | Backlog of log data waiting to be applied | Shows secondary-side bottlenecks |
| **Redo Rate** | Rate of log processing on secondary | Shows secondary processing capacity |

---
**Generated by OpenTelemetry SQL Server Receiver Load Testing Suite**