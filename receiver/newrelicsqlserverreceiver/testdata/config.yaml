
extensions:
  health_check:
    endpoint: localhost:1313

service:
  extensions: [health_check]
  pipelines:
    metrics:
      receivers: [newrelicsqlserver]
      processors: [memory_limiter, batch, resource]
      exporters: [otlphttp, debug]
    
    # Logs pipeline: receiver -> processor -> exporter (for execution plans)
    logs:
      receivers: [newrelicsqlserver]
      processors: [memory_limiter, batch, resource]
      exporters: [otlphttp/logs, debug]
  
  # Telemetry configuration for the collector itself
  telemetry:
    logs:
      level: debug  # Changed from info to debug for verbose logging
    metrics:
      level: none

processors:
  # Memory limiter prevents out-of-memory issues
  memory_limiter:
    check_interval: 1s
    limit_mib: 256
    spike_limit_mib: 64
  
  batch:
    timeout: 10s
    send_batch_size: 1024
  
  resource:
    attributes:
      - key: deployment.environment
        value: "production"
        action: upsert
      - key: service.name
        value: "sql-server-monitoring"
        action: upsert
      - key: service.version
        value: "1.0.0"
        action: upsert
      - key: entity.name
        value: "sqlserver.execution_plan_operator"
        action: upsert

receivers:
  newrelicsqlserver:
    # SQL Server connection
    hostname: ""
    port: "1433"
    username: "sa"
    password: ""
    collection_interval: 15s
    
    # Core instance metrics
    timeout: 300s
    query_monitoring_fetch_interval: 300 
    enable_instance_memory_metrics: true
    enable_instance_comprehensive_stats: true
    enable_instance_stats: true
    enable_instance_buffer_pool_hit_percent: true
    enable_instance_process_counts: true
    enable_instance_runnable_tasks: true
    enable_instance_disk_metrics: true
    enable_instance_active_connections: true
    enable_instance_buffer_pool_size: true
    
    # Enhanced metrics (new)
    enable_instance_target_memory_metrics: true      # Target server memory
    enable_instance_performance_ratios_metrics: true # Compilations/batch ratios
    enable_instance_index_metrics: true              # Full scans performance
    enable_instance_lock_metrics: true               # Lock timeouts
    enable_latch_wait_time_metrics: true             # Latch wait metrics
    
    # Security metrics
    enable_security_metrics: true
    enable_security_principals_metrics: true
    enable_security_role_members_metrics: true
    
    # Query monitoring
    enable_query_monitoring: true

    # Enable active running queries monitoring (captures currently executing queries with waits)
    enable_active_running_queries: true

    # Query monitoring thresholds (required when enable_query_monitoring is true)
    query_monitoring_response_time_threshold: 1  # milliseconds - capture queries taking > 1ms (effectively all queries)
    query_monitoring_count_threshold: 20           # minimum execution count for queries to be monitored
    query_monitoring_text_truncate_limit: 4094    # characters - maximum length of SQL text in query monitoring results (4KB - 2 bytes)

exporters:
  # New Relic OTLP endpoint
  otlphttp:
    # New Relic OTLP endpoint (HTTP uses port 4318, not 4317)
    endpoint: "https://staging-otlp.nr-data.net:4318"
    
    # Headers for authentication
    headers:
      # ⚠️  REPLACE WITH YOUR ACTUAL NEW RELIC LICENSE KEY ⚠️
      api-key: ""
    
    # TLS configuration
    tls:
      insecure: false
    
    # Retry configuration
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 300s
    
    # Queue configuration for handling bursts
    sending_queue:
      enabled: true
      num_consumers: 2
      queue_size: 100
    
    # Compression (gzip is recommended)
    compression: gzip
    
    # Timeout for HTTP requests
    timeout: 30s
  
  # New Relic OTLP HTTP Exporter for Logs (Execution Plans)
  otlphttp/logs:
    # New Relic OTLP logs endpoint (HTTP uses port 4318, not 4317)
    endpoint: "https://staging-otlp.nr-data.net:4318"
    
    # Headers for authentication
    headers:
      # ⚠️  REPLACE WITH YOUR ACTUAL NEW RELIC LICENSE KEY ⚠️
      api-key: ""
    
    # TLS configuration
    tls:
      insecure: false
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 300s
    sending_queue:
      enabled: true
      num_consumers: 2
      queue_size: 100
    compression: gzip
    timeout: 30s
  
  # Debug output to console
  debug:
    verbosity: detailed
    sampling_initial: 2
    sampling_thereafter: 500