receivers:
  newrelicpostgresql/primary:
    # PostgreSQL connection configuration (REPLICA)
    hostname: localhost
    # Primary port for local testing with Docker Compose
    port: "5432" # Primary port (pg-primary container)
    username: postgres
    password: Praveen123
    database: pagila

    # newrelicpostgresql/replica:
    #   # Replica port for local testing with Docker Compose
    #   hostname: localhost
    #   port: "5433" # Replica port (pg-replica container)
    #   username: replicator
    #   password: reppass123
    #   database: postgres

    # Collection interval
    collection_interval: 5s # Reduced for testing CLUSTER progress metrics

    # Timeout for database operations
    timeout: 30s

    # SSL configuration (optional)
    ssl_mode: disable
    # ssl_cert: /path/to/cert.pem
    # ssl_key: /path/to/key.pem
    # ssl_root_cert: /path/to/ca.pem

    # Per-table metrics configuration (OPTIONAL - HIGH CARDINALITY!)
    # Uncomment to enable per-table vacuum/analyze metrics
    # Only collects metrics for specified tables to prevent cardinality explosion
    relations:
      schemas: [public]
      tables:
        [
          actor,
          film,
          customer,
          payment,
          rental,
          inventory,
          address,
          city,
          country,
        ]

processors:
  # Convert cumulative metrics to delta for better New Relic compatibility
  cumulativetodelta:
    # Convert all cumulative sum metrics to delta
    include:
      match_type: strict
      metrics:
        - postgresql.recovery_prefetch.hit
        - postgresql.recovery_prefetch.prefetch
        - postgresql.recovery_prefetch.skip_init
        - postgresql.recovery_prefetch.skip_new
        - postgresql.recovery_prefetch.skip_fpw
        - postgresql.recovery_prefetch.skip_rep
        - postgresql.archiver.archived_count
        - postgresql.archiver.failed_count
        - postgresql.bgwriter.buffers_alloc
        - postgresql.bgwriter.buffers_backend
        - postgresql.bgwriter.buffers_backend_fsync
        - postgresql.bgwriter.buffers_checkpoint
        - postgresql.bgwriter.buffers_clean
        - postgresql.bgwriter.checkpoints_requested
        - postgresql.bgwriter.checkpoints_timed
        - postgresql.bgwriter.maxwritten_clean
        - postgresql.bgwriter.sync_time
        - postgresql.bgwriter.write_time
        - postgresql.buffer_hit
        - postgresql.checksums.failures
        - postgresql.commits
        - postgresql.conflicts
        - postgresql.conflicts.bufferpin
        - postgresql.conflicts.deadlock
        - postgresql.conflicts.lock
        - postgresql.conflicts.snapshot
        - postgresql.conflicts.tablespace
        - postgresql.deadlocks
        - postgresql.disk_read
        - postgresql.rollbacks
        - postgresql.rows_deleted
        - postgresql.rows_fetched
        - postgresql.rows_inserted
        - postgresql.rows_returned
        - postgresql.rows_updated
        - postgresql.sessions.abandoned
        - postgresql.sessions.count
        - postgresql.sessions.fatal
        - postgresql.sessions.killed
        - postgresql.slru.blks_zeroed
        - postgresql.slru.blks_hit
        - postgresql.slru.blks_read
        - postgresql.slru.blks_written
        - postgresql.slru.blks_exists
        - postgresql.slru.flushes
        - postgresql.slru.truncates
        - postgresql.subscription.apply_error
        - postgresql.subscription.sync_error
        - postgresql.temp_bytes
        - postgresql.temp_files
        - postgresql.wal.buffers_full
        - postgresql.wal.bytes
        - postgresql.wal.fpi
        - postgresql.wal.records
        - postgresql.wal.sync
        - postgresql.wal.write
        - postgresql.replication_slot.spill_bytes
        - postgresql.replication_slot.spill_count
        - postgresql.replication_slot.spill_txns
        - postgresql.replication_slot.stream_bytes
        - postgresql.replication_slot.stream_count
        - postgresql.replication_slot.stream_txns
        - postgresql.replication_slot.total_bytes
        - postgresql.replication_slot.total_txns
        # Table metrics (per-table, requires relations config)
        - postgresql.vacuumed
        - postgresql.autovacuumed
        - postgresql.analyzed
        - postgresql.autoanalyzed
        # Table I/O metrics (per-table, requires relations config)
        - postgresql.heap_blocks_read
        - postgresql.heap_blocks_hit
        - postgresql.index_blocks_read
        - postgresql.index_blocks_hit
        - postgresql.toast_blocks_read
        - postgresql.toast_blocks_hit
        - postgresql.toast_index_blocks_read
        - postgresql.toast_index_blocks_hit
        # Index statistics (per-index, requires relations config)
        - postgresql.index_scans
        - postgresql.index_tuples_read
        - postgresql.index_tuples_fetched
        # TOAST table statistics (requires relations config)
        - postgresql.toast.vacuumed
        - postgresql.toast.autovacuumed

  batch:
    timeout: 10s
    send_batch_size: 1024

exporters:
  # New Relic OTLP exporter (staging)
  otlphttp:
    endpoint: https://staging-otlp.nr-data.net:4318
    headers:
      api-key: 5848a0c9c053a43ff9c2cc5af33cfe60FFFFNRAL
    compression: gzip
    timeout: 30s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

  # Debug exporter for local testing
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    metrics:
      receivers: [newrelicpostgresql/primary]
      processors: [cumulativetodelta, batch]
      exporters: [otlphttp, debug]

  # telemetry:
  #   logs:
  #     level: info
  #     development: false
  #     encoding: console
  #     disable_caller: false
  #     disable_stacktrace: false
  #     initial_fields:
  #       service: otel-postgres-receiver
