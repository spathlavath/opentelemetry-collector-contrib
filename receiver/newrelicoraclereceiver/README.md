# New Relic Oracle Database Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: metrics   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fnewrelicoracledb%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fnewrelicoracledb) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fnewrelicoracledb%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fnewrelicoracledb) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

This receiver collects comprehensive metrics from an Oracle Database, based on the New Relic Oracle Database integration. It provides extensive monitoring capabilities including SGA metrics, memory usage, disk I/O, query performance, tablespace utilization, and more.

The receiver connects to a database host and performs periodic queries to gather metrics that match those provided by the New Relic Oracle integration.

## Features

- **Comprehensive Metric Coverage**: Collects all metrics available in the New Relic Oracle integration
- **SGA Monitoring**: Buffer cache hit ratios, shared pool metrics, log buffer statistics
- **Memory Management**: PGA usage, allocation, and freeable memory tracking
- **Disk I/O Performance**: Physical reads/writes, block operations, timing metrics
- **Query Performance**: Transaction rates, parse statistics, execution metrics
- **Database Health**: Session counts, CPU usage, wait times, response times
- **Tablespace Management**: Usage percentages, space allocation, offline detection
- **Network Monitoring**: Traffic volume, I/O requests and throughput
- **Instance Monitoring**: Long-running queries, locked accounts, background processes

## Getting Started

### Configuration

The receiver supports two configuration methods:

#### Primary Configuration (Recommended)

Use a complete Oracle connection string:

```yaml
receivers:
  newrelicoracledb:
    datasource: "oracle://username:password@hostname:port/service_name"
    collection_interval: 30s
    extended_metrics: true
```

#### Secondary Configuration

Configure connection parameters separately:

```yaml
receivers:
  newrelicoracledb:
    endpoint: "hostname:1521"
    username: "monitoring_user"
    password: "secure_password"
    service: "ORCL"
    collection_interval: 30s
    extended_metrics: true
```

### Full Configuration Options

```yaml
receivers:
  newrelicoracledb:
    # Connection settings (choose one approach)
    datasource: "oracle://user:pass@host:port/service"  # Primary option
    # OR
    endpoint: "hostname:1521"      # Secondary option
    username: "monitoring_user"   # Secondary option
    password: "secure_password"   # Secondary option
    service: "ORCL"              # Secondary option

    # Collection settings
    collection_interval: 30s      # How often to collect metrics
    initial_delay: 1s            # Delay before first collection
    timeout: 30s                 # Query timeout (0 = no timeout)

    # Metric collection options
    extended_metrics: false       # Include extended/detailed metrics
    sysmetrics_source: "SYS"     # Options: "SYS", "PDB", "ALL"

    # Tablespace filtering
    tablespace_whitelist:         # Only collect metrics for these tablespaces
      - "USERS"
      - "TEMP"
      - "SYSTEM"

    # Custom metrics
    custom_metrics_query: ""      # Custom SQL query for additional metrics
    custom_metrics_config: ""     # Path to custom metrics configuration file

    # Performance tuning
    skip_metrics_groups:          # Skip collection of specific metric groups
      - "tablespace_metrics"
      - "pdb_metrics"
```

## Database Permissions

Grant the following minimum permissions to the monitoring user:

```sql
-- Basic permissions for metric collection
GRANT SELECT ON V_$SESSION TO monitoring_user;
GRANT SELECT ON V_$SYSSTAT TO monitoring_user;
GRANT SELECT ON V_$SYSMETRIC TO monitoring_user;
GRANT SELECT ON V_$INSTANCE TO monitoring_user;
GRANT SELECT ON V_$DATABASE TO monitoring_user;
GRANT SELECT ON V_$SGA TO monitoring_user;
GRANT SELECT ON V_$PGASTAT TO monitoring_user;
GRANT SELECT ON V_$FILESTAT TO monitoring_user;
GRANT SELECT ON V_$LIBRARYCACHE TO monitoring_user;
GRANT SELECT ON V_$ROWCACHE TO monitoring_user;
GRANT SELECT ON V_$ROLLSTAT TO monitoring_user;
GRANT SELECT ON V_$SYSTEM_EVENT TO monitoring_user;
GRANT SELECT ON GLOBAL_NAME TO monitoring_user;

-- Tablespace monitoring
GRANT SELECT ON DBA_TABLESPACES TO monitoring_user;
GRANT SELECT ON DBA_DATA_FILES TO monitoring_user;
GRANT SELECT ON DBA_TABLESPACE_USAGE_METRICS TO monitoring_user;

-- User account monitoring
GRANT SELECT ON DBA_USERS TO monitoring_user;

-- For PDB environments
GRANT SELECT ON CDB_USERS TO monitoring_user;
GRANT SELECT ON CDB_PDBS TO monitoring_user;
GRANT SELECT ON CDB_DATA_FILES TO monitoring_user;
GRANT SELECT ON V_$CON_SYSMETRIC TO monitoring_user;
```

## Metrics

The receiver collects the following metric categories:

### SGA Metrics
- `newrelic.oracle.sga.hit_ratio` - Buffer cache hit ratio
- `newrelic.oracle.sga.fixed_size_bytes` - SGA fixed size area
- `newrelic.oracle.sga.redo_buffers_bytes` - Redo buffer size
- `newrelic.oracle.sga.shared_pool_library_cache_hit_ratio` - Library cache hit ratio
- `newrelic.oracle.sga.shared_pool_library_cache_reload_ratio` - Library cache reload ratio
- And many more SGA-related metrics...

### Memory Metrics
- `newrelic.oracle.memory.pga_in_use_bytes` - PGA memory in use
- `newrelic.oracle.memory.pga_allocated_bytes` - PGA allocated memory
- `newrelic.oracle.memory.pga_freeable_bytes` - PGA freeable memory
- `newrelic.oracle.memory.buffer_cache_hit_ratio` - Buffer cache hit ratio
- And additional memory metrics...

### Disk I/O Metrics
- `newrelic.oracle.disk.reads` - Physical disk reads
- `newrelic.oracle.disk.writes` - Physical disk writes
- `newrelic.oracle.disk.blocks_read` - Physical blocks read
- `newrelic.oracle.disk.blocks_written` - Physical blocks written
- `newrelic.oracle.disk.read_time_milliseconds` - Read time
- `newrelic.oracle.disk.write_time_milliseconds` - Write time
- And more I/O performance metrics...

### Query Performance Metrics
- `newrelic.oracle.query.transactions_per_second` - Transaction rate
- `newrelic.oracle.query.physical_reads_per_transaction` - Reads per transaction
- `newrelic.oracle.query.physical_writes_per_transaction` - Writes per transaction

### Database Health Metrics
- `newrelic.oracle.db.session_count` - Active session count
- `newrelic.oracle.db.cpu_usage_per_second` - CPU usage rate
- `newrelic.oracle.db.sql_service_response_time` - SQL response time
- `newrelic.oracle.db.wait_time_ratio` - Database wait time ratio
- And comprehensive database health metrics...

### Tablespace Metrics
- `newrelic.oracle.tablespace.space_consumed_bytes` - Used space per tablespace
- `newrelic.oracle.tablespace.space_reserved_bytes` - Total space per tablespace
- `newrelic.oracle.tablespace.space_used_percentage` - Usage percentage per tablespace
- `newrelic.oracle.tablespace.is_offline` - Offline status per tablespace

### Instance Metrics
- `newrelic.oracle.long_running_queries` - Count of long-running queries
- `newrelic.oracle.locked_accounts` - Number of locked user accounts

For a complete list of available metrics, see the [metadata.yaml](metadata.yaml) file.

## Metric Selection

You can enable or disable specific metrics using the metrics configuration:

```yaml
receivers:
  newrelicoracledb:
    datasource: "oracle://user:pass@host:port/service"
    metrics:
      newrelic.oracle.sga.hit_ratio:
        enabled: true
      newrelic.oracle.memory.pga_in_use_bytes:
        enabled: false
      newrelic.oracle.tablespace.space_used_percentage:
        enabled: true
```

## Advanced Configuration

### Custom Metrics

You can collect additional metrics using custom SQL queries:

```yaml
receivers:
  newrelicoracledb:
    datasource: "oracle://user:pass@host:port/service"
    custom_metrics_query: |
      SELECT 
        'custom_sessions' as metric_name,
        COUNT(*) as metric_value
      FROM v$session 
      WHERE username IS NOT NULL
```

### Performance Tuning

For high-frequency collection or large databases:

```yaml
receivers:
  newrelicoracledb:
    datasource: "oracle://user:pass@host:port/service"
    collection_interval: 60s      # Reduce frequency for large DBs
    timeout: 45s                  # Increase timeout for slow queries
    skip_metrics_groups:          # Skip expensive metric groups
      - "tablespace_metrics"
    tablespace_whitelist:         # Limit tablespace monitoring
      - "SYSTEM"
      - "USERS"
```

## Troubleshooting

### Common Issues

1. **Connection Failures**
   - Verify Oracle client libraries are installed
   - Check network connectivity and firewall rules
   - Validate connection string format
   - Ensure Oracle service is running

2. **Permission Errors**
   - Grant required SELECT permissions to monitoring user
   - Check if user has access to system views
   - Verify PDB permissions for container databases

3. **High Resource Usage**
   - Increase collection interval
   - Use tablespace whitelist to limit scope
   - Skip expensive metric groups
   - Consider running during off-peak hours

4. **Missing Metrics**
   - Check database version compatibility
   - Verify extended_metrics setting
   - Review skip_metrics_groups configuration
   - Check database logs for permission issues

### Debug Logging

Enable debug logging to troubleshoot issues:

```yaml
service:
  telemetry:
    logs:
      level: debug
      development: true
```

## Examples

### Basic Monitoring Setup

```yaml
receivers:
  newrelicoracledb:
    datasource: "oracle://monitor:password@db.example.com:1521/PROD"
    collection_interval: 30s
    extended_metrics: true

exporters:
  otlp:
    endpoint: "https://api.newrelic.com/v1/trace"
    headers:
      api-key: "your-api-key"

service:
  pipelines:
    metrics:
      receivers: [newrelicoracledb]
      exporters: [otlp]
```

### Production Setup with Filtering

```yaml
receivers:
  newrelicoracledb:
    datasource: "oracle://monitoring_user:secure_pass@prod-db:1521/PRODDB"
    collection_interval: 60s
    extended_metrics: false
    tablespace_whitelist:
      - "USERS"
      - "TEMP"
      - "SYSTEM"
      - "SYSAUX"
    skip_metrics_groups:
      - "pdb_metrics"

processors:
  filter:
    metrics:
      include:
        match_type: regexp
        metric_names:
          - "newrelic\\.oracle\\.(sga|memory|disk|db)\\..*"

exporters:
  prometheusremotewrite:
    endpoint: "https://prometheus.example.com/api/v1/write"

service:
  pipelines:
    metrics:
      receivers: [newrelicoracledb]
      processors: [filter]
      exporters: [prometheusremotewrite]
```
