# OpenTelemetry Collector Configuration for New Relic SQL Server Integration
# SQL Server On-Premises/VM Configuration
# Optimized for Standard SQL Server (Engine Edition 3) on-premises deployments

# Extensions provide additional functionality
extensions:
  # Health check endpoint for monitoring collector health
  health_check:
    endpoint: localhost:13133

# Service configuration
service:
  # Enable extensions
  extensions: [health_check]

  # Define the data pipeline
  pipelines:
    # Metrics pipeline: receiver -> processor -> exporter
    metrics:
      receivers: [newrelicsqlserver]
      processors: [memory_limiter, batch, resource]
      exporters: [otlphttp, debug]

  # Telemetry configuration for the collector itself
  telemetry:
    logs:
      level: info # Set to debug for troubleshooting
    metrics:
      level: none # Disable internal metrics to avoid port conflicts

# Processors transform and enrich the data
processors:
  # Memory limiter prevents out-of-memory issues
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Batch processor groups data for efficient transmission
  batch:
    timeout: 10s
    send_batch_size: 512
    send_batch_max_size: 1000

  # Resource processor adds metadata to all telemetry
  resource:
    attributes:
      - key: deployment.environment
        value: "staging"
        action: upsert
      - key: service.name
        value: "sql-server-onpremises-monitoring"
        action: upsert

# Receivers collect telemetry data
receivers:
  # New Relic SQL Server Receiver - On-Premises Configuration
  newrelicsqlserver:
    # =============================================================================
    # ON-PREMISES SQL SERVER CONNECTION CONFIGURATION
    # =============================================================================
    hostname: "74.225.24.140" # IP address or FQDN of your SQL Server
    port: "1433" # Standard SQL Server port
    username: "pkudikyala-wind\\pkudikyala" # Windows domain or SQL Server authentication
    password: "Pkudikyala@1991"
    enable_ssl: false # Usually false for on-premises, set to true for production
    trust_server_certificate: true

    # =============================================================================
    # TIMING CONFIGURATION
    # =============================================================================
    collection_interval: 60s # How often to collect metrics
    timeout: 30s # Connection timeout

    # =============================================================================
    # METRICS CONFIGURATION
    # =============================================================================
    # Comprehensive monitoring for on-premises SQL Server

    # =============================================================================
    # GRANULAR METRIC CONFIGURATION
    # =============================================================================
    # All metrics are enabled by default (true). Only specify toggles you want to disable.
    # Uncomment and set to false to disable specific metrics:

    # Database Sample Metrics (core database monitoring) - all enabled by default
    # enable_buffer_metrics: false                     # Buffer pool size metrics
    # enable_database_reserve_metrics: false           # Database space reservation metrics
    # enable_disk_metrics_in_bytes: false             # Disk space usage metrics
    # enable_io_metrics: false                         # I/O stall time metrics
    # enable_log_growth_metrics: false                # Transaction log growth metrics
    # enable_page_file_metrics: false                 # Page file availability metrics
    # enable_page_file_total_metrics: false           # Page file total metrics
    # enable_memory_metrics: false                     # Memory usage metrics
    # enable_memory_total_metrics: false              # Total memory metrics
    # enable_memory_available_metrics: false          # Available memory metrics
    # enable_memory_utilization_metrics: false        # Memory utilization percentage

    # System Performance Metrics (new metrics) - all enabled by default
    # enable_system_cpu_queue_metrics: false          # Average CPU queue length
    # enable_system_memory_pages_metrics: false       # Memory pages/sec
    # enable_system_disk_queue_metrics: false         # Average disk queue length

    # Failover Cluster Metrics (Always On AGs and Windows Clustering) - all enabled by default
    # enable_failover_cluster_replica_metrics: false                 # Replica performance metrics
    # enable_failover_cluster_replica_state_metrics: false           # Replica state and sync status
    # enable_failover_cluster_availability_group_health_metrics: false # AG health and role status
    # enable_failover_cluster_availability_group_metrics: false      # AG configuration metrics
    # enable_failover_cluster_redo_queue_metrics: false              # Redo queue metrics

    # Database Principals Metrics (security and user management) - enabled by default
    # enable_database_principals_details_metrics: false              # Database user and role details

    # Database Role Membership Metrics (role assignments and permissions) - enabled by default
    # enable_database_role_membership_details_metrics: false         # Role membership details

    # User Connection Metrics (connection monitoring and analysis) - all enabled by default
    # enable_user_connection_status_metrics: false      # Individual connection status counts
    # enable_user_connection_summary_metrics: false     # Aggregated connection counts by status
    # enable_user_connection_utilization_metrics: false # Connection efficiency ratios and percentages
    # enable_user_connection_client_metrics: false      # Connections by host/program
    # enable_user_connection_client_summary: false      # Aggregated client statistics
    # enable_user_connection_stats_metrics: false       # General statistical analysis metrics

    # =============================================================================
    # QUERY MONITORING CONFIGURATION
    # =============================================================================
    enable_query_monitoring: true # Enable query performance monitoring
    query_monitoring_response_time_threshold: 1000 # Monitor queries > 1000ms
    query_monitoring_count_threshold: 10 # Monitor queries executed > 10 times
    query_monitoring_fetch_interval: 15 # Fetch query stats every 15 seconds

    # =============================================================================
    # PERFORMANCE TUNING
    # =============================================================================
    max_concurrent_workers: 5

# Exporters send telemetry data to destinations
exporters:
  # New Relic OTLP HTTP Exporter
  otlphttp:
    # New Relic OTLP endpoint
    endpoint: "https://staging-otlp.nr-data.net:4318"

    # Headers for New Relic authentication
    headers:
      # New Relic License Key - UPDATE WITH YOUR KEY
      api-key: "5848a0c9c053a43ff9c2cc5af33cfe60FFFFNRAL"

    # TLS configuration for HTTPS
    tls:
      insecure: false
      insecure_skip_verify: false

    # Retry configuration for robust delivery
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 300s
      randomization_factor: 0.5

    # Queue configuration for handling traffic bursts
    sending_queue:
      enabled: true
      num_consumers: 4
      queue_size: 200

    # Enable gzip compression for better performance
    compression: gzip

    # HTTP request timeout
    timeout: 30s

  # Debug exporter for local troubleshooting
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 100
# =============================================================================
# ON-PREMISES SQL SERVER NOTES
# =============================================================================

# CONFIGURATION STEPS:
# 1. Update hostname to your SQL Server IP/FQDN
# 2. Update username/password for your authentication method
# 3. Consider enabling SSL for production environments
# 4. Ensure Windows Firewall allows connections on port 1433
# 5. Run: ./bin/otelcontribcol_darwin_arm64 --config=sql-server-onpremises-config.yaml

# AUTHENTICATION OPTIONS:
# - Windows Authentication: "DOMAIN\\username"
# - SQL Server Authentication: "sql_username"
# - Service Account: Recommended for production

# AVAILABLE METRICS:
# ✅ All instance metrics (memory, performance, connections, etc.)
# ✅ All database metrics (size, transactions, I/O, etc.)
# ✅ All user connection metrics
# ✅ All security metrics
# ✅ Failover cluster metrics (if clustered)
# ✅ Query performance monitoring
# ✅ Authentication tracking

# NETWORK REQUIREMENTS:
# - Port 1433 accessible from collector host
# - Windows Firewall configured appropriately
# - SQL Server Browser service running (if using named instances)

# SECURITY CONSIDERATIONS:
# - Use dedicated service account with minimal permissions
# - Enable SSL/TLS for production environments
# - Regular credential rotation
# - Network segmentation and firewall rules
