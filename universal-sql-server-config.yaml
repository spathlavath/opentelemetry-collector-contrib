# OpenTelemetry Collector Configuration for New Relic SQL Server Integration
# Universal Configuration for All SQL Server Environments
# Supports: SQL Server On-Premises, Azure SQL Database, Azure SQL Managed Instance
#
# IMPORTANT: Configure the connection section below for your specific environment

# Extensions provide additional functionality
extensions:
  # Health check endpoint for monitoring collector health
  health_check:
    endpoint: localhost:13133

# Service configuration
service:
  # Enable extensions
  extensions: [health_check]

  # Define the data pipeline
  pipelines:
    # Metrics pipeline: receiver -> processor -> exporter
    metrics:
      receivers: [newrelicsqlserver]
      processors: [memory_limiter, batch, resource]
      exporters: [otlphttp, debug]

  # Telemetry configuration for the collector itself
  telemetry:
    logs:
      level: info # Set to debug for troubleshooting
    metrics:
      level: none # Disable internal metrics to avoid port conflicts

# Processors transform and enrich the data
processors:
  # Memory limiter prevents out-of-memory issues
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Batch processor groups data for efficient transmission
  batch:
    timeout: 10s
    send_batch_size: 512
    send_batch_max_size: 1000

  # Resource processor adds metadata to all telemetry
  resource:
    attributes:
      - key: deployment.environment
        value: "staging"
        action: upsert
      - key: service.name
        value: "universal-sql-server-monitoring"
        action: upsert
      - key: service.version
        value: "1.0.0"
        action: upsert
      - key: cloud.provider
        value: "azure" # Change to "on-premises" for on-host deployments
        action: upsert
      # Additional environment-specific attributes can be added here

# Receivers collect telemetry data
receivers:
  # New Relic SQL Server Receiver - Universal Configuration
  newrelicsqlserver:
    # =============================================================================
    # CONNECTION CONFIGURATION - UPDATE FOR YOUR ENVIRONMENT
    # =============================================================================

    # FOR SQL SERVER ON-PREMISES/VM:
    hostname: "74.225.24.140" # IP address or FQDN of your SQL Server
    port: "1433" # Standard SQL Server port
    username: "pkudikyala-wind\\pkudikyala" # Windows domain or SQL Server authentication
    password: "Pkudikyala@1991"
    enable_ssl: false # Usually false for on-premises, true for production
    trust_server_certificate: true

    # FOR AZURE SQL DATABASE:
    # hostname: "your-server.database.windows.net"
    # port: "1433"
    # username: "your-azure-sql-username" # No domain prefix
    # password: "your-azure-sql-password"
    # enable_ssl: true # REQUIRED for Azure SQL Database
    # trust_server_certificate: true

    # FOR AZURE SQL MANAGED INSTANCE (Private Endpoint):
    # hostname: "your-managed-instance.dns-zone.database.windows.net"
    # port: "1433"
    # username: "your-managed-instance-username"
    # password: "your-managed-instance-password"
    # enable_ssl: true # REQUIRED for Azure SQL Managed Instance
    # trust_server_certificate: true

    # FOR AZURE SQL MANAGED INSTANCE (Public Endpoint):
    # hostname: "your-managed-instance.public.dns-zone.database.windows.net"
    # port: "3342" # Different port for public endpoint
    # username: "your-managed-instance-username"
    # password: "your-managed-instance-password"
    # enable_ssl: true # REQUIRED for Azure SQL Managed Instance
    # trust_server_certificate: true

    # =============================================================================
    # TIMING CONFIGURATION
    # =============================================================================
    collection_interval: 60s # How often to collect metrics
    timeout: 30s # Connection timeout

    # =============================================================================
    # GRANULAR METRIC CONFIGURATION
    # =============================================================================
    # All metrics are enabled by default (true). Only uncomment and configure toggles
    # you want to override from defaults or platform-specific requirements.

    # Database Sample Metrics (core database monitoring)
    # enable_buffer_metrics: false                     # Buffer pool size metrics
    # enable_database_reserve_metrics: false           # Database space reservation metrics
    # enable_disk_metrics_in_bytes: false             # Disk space usage metrics
    # enable_io_metrics: false                         # I/O stall time metrics
    # enable_log_growth_metrics: false                # Transaction log growth metrics
    # enable_page_file_metrics: false                 # Page file availability metrics
    # enable_page_file_total_metrics: false           # Page file total metrics
    # enable_memory_metrics: false                     # Memory usage metrics (on-premises/Azure SQL DB only)
    # enable_memory_total_metrics: false              # Total memory metrics (on-premises/Azure SQL DB only)
    # enable_memory_available_metrics: false          # Available memory metrics (on-premises/Azure SQL DB only)
    # enable_memory_utilization_metrics: false        # Memory utilization percentage (on-premises/Azure SQL DB only)

    # System Performance Metrics (new metrics)
    # enable_system_cpu_queue_metrics: false          # Average CPU queue length
    # enable_system_memory_pages_metrics: false       # Memory pages/sec
    # enable_system_disk_queue_metrics: false         # Average disk queue length

    # Failover Cluster Metrics (Always On Availability Groups and Windows Clustering)
    # enable_failover_cluster_replica_metrics: false                 # Replica performance metrics
    # enable_failover_cluster_replica_state_metrics: false           # Replica state and sync status
    # enable_failover_cluster_availability_group_health_metrics: false # AG health and role status
    # enable_failover_cluster_availability_group_metrics: false      # AG configuration metrics
    # enable_failover_cluster_redo_queue_metrics: false              # Redo queue metrics (Azure SQL MI only)

    # Database Principals Metrics (security and user management)
    # enable_database_principals_details_metrics: false              # Database user and role details

    # Database Role Membership Metrics (role assignments and permissions)
    # enable_database_role_membership_details_metrics: false         # Role membership details

    # User Connection Metrics (connection monitoring and analysis)
    # enable_user_connection_status_metrics: false      # Individual connection status counts
    # enable_user_connection_summary_metrics: false     # Aggregated connection counts by status
    # enable_user_connection_utilization_metrics: false # Connection efficiency ratios and percentages
    # enable_user_connection_client_metrics: false      # Connections by host/program
    # enable_user_connection_client_summary: false      # Aggregated client statistics
    # enable_user_connection_stats_metrics: false       # General statistical analysis metrics

    # =============================================================================
    # QUERY MONITORING CONFIGURATION
    # =============================================================================
    enable_query_monitoring: true # Enable query performance monitoring
    query_monitoring_response_time_threshold: 1000 # Monitor queries > 1000ms
    query_monitoring_count_threshold: 10 # Monitor queries executed > 10 times
    query_monitoring_fetch_interval: 15 # Fetch query stats every 15 seconds

    # =============================================================================
    # PERFORMANCE TUNING
    # =============================================================================
    max_concurrent_workers: 5

# Exporters send telemetry data to destinations
exporters:
  # New Relic OTLP HTTP Exporter
  otlphttp:
    # New Relic OTLP endpoint
    endpoint: "https://staging-otlp.nr-data.net:4318"

    # Headers for New Relic authentication
    headers:
      # New Relic License Key - UPDATE WITH YOUR KEY
      api-key: "5848a0c9c053a43ff9c2cc5af33cfe60FFFFNRAL"

    # TLS configuration for HTTPS
    tls:
      insecure: false
      insecure_skip_verify: false

    # Retry configuration for robust delivery
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 300s
      randomization_factor: 0.5

    # Queue configuration for handling traffic bursts
    sending_queue:
      enabled: true
      num_consumers: 4
      queue_size: 200

    # Enable gzip compression for better performance
    compression: gzip

    # HTTP request timeout
    timeout: 30s

  # Debug exporter for local troubleshooting
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 100
# =============================================================================
# ENVIRONMENT-SPECIFIC CONFIGURATION EXAMPLES
# =============================================================================

# TO USE THIS CONFIG FOR SQL SERVER ON-PREMISES/VM:
# 1. Update hostname to your SQL Server IP/FQDN
# 2. Update username/password for your authentication method
# 3. Set enable_ssl: false (unless using certificates)
# 4. Update cloud.provider to "on-premises" in resource processor
# 5. Run: ./bin/otelcontribcol_darwin_arm64 --config=universal-sql-server-config.yaml

# TO USE THIS CONFIG FOR AZURE SQL DATABASE:
# 1. Update hostname to: "your-server.database.windows.net"
# 2. Update username/password (no domain prefix for username)
# 3. Set enable_ssl: true (REQUIRED)
# 4. Update azure.sql.engine_edition to "5" in resource processor
# 5. Update azure.sql.service_type to "database" in resource processor
# 6. Run: ./bin/otelcontribcol_darwin_arm64 --config=universal-sql-server-config.yaml

# TO USE THIS CONFIG FOR AZURE SQL MANAGED INSTANCE:
# 1. Update hostname to: "your-instance.dns-zone.database.windows.net" (private)
#    OR "your-instance.public.dns-zone.database.windows.net" (public)
# 2. Update port to "1433" (private) or "3342" (public)
# 3. Update username/password (no domain prefix for username)
# 4. Set enable_ssl: true (REQUIRED)
# 5. Update azure.sql.engine_edition to "8" in resource processor
# 6. Update azure.sql.service_type to "managed_instance" in resource processor
# 7. Run: ./bin/otelcontribcol_darwin_arm64 --config=universal-sql-server-config.yaml

# =============================================================================
# COMPREHENSIVE METRICS COMPATIBILITY BY ENVIRONMENT
# =============================================================================

# ✅ INSTANCE METRICS (Available on all environments):
# - sqlserver.instance.memory_usage
# - sqlserver.instance.comprehensive_stats
# - sqlserver.instance.buffer_pool_hit_percent
# - sqlserver.instance.process_counts
# - sqlserver.instance.runnable_tasks
# - sqlserver.instance.disk_metrics
# - sqlserver.instance.active_connections
# - sqlserver.instance.buffer_pool_size
# - sqlserver.instance.target_memory
# - sqlserver.instance.performance_ratios
# - sqlserver.instance.index_metrics
# - sqlserver.instance.lock_metrics

# ✅ DATABASE METRICS (Available on all environments):
# - sqlserver.database.size.totalSizeMB
# - sqlserver.database.size.dataSizeMB
# - sqlserver.database.log.usedSpaceMB
# - sqlserver.database.log.flushesPerSec
# - sqlserver.database.log.bytesFlushesPerSec
# - sqlserver.database.bufferpool.sizePerDatabaseInBytes
# - sqlserver.database.io.stallInMilliseconds
# - sqlserver.database.transactions.active
# - sqlserver.database.log.transactionGrowth
# - sqlserver.database.pageFileAvailable
# - sqlserver.database.pageFileTotal

# ✅ USER CONNECTION METRICS (Available on all environments):
# - sqlserver.user_connections.total
# - sqlserver.user_connections.running
# - sqlserver.user_connections.sleeping
# - sqlserver.user_connections.suspended
# - sqlserver.user_connections.utilization.*
# - sqlserver.user_connections.client.*
# - sqlserver.user_connections.authentication.*

# ✅ SECURITY METRICS (Available on all environments):
# - sqlserver.security.principals.*
# - sqlserver.security.role_members.*
# - sqlserver.database.principals.*
# - sqlserver.database.role_membership.*

# ✅ WAIT TIME METRICS (Available on all environments):
# - sqlserver.wait.latch.*
# - sqlserver.wait.time_seconds
# - sqlserver.blocked.spid

# ✅ QUERY MONITORING METRICS (Available on all environments):
# - sqlserver.query.response_time
# - sqlserver.query.execution_count
# - sqlserver.query.performance.*

# ✅ AZURE SQL DATABASE ONLY:
# - sqlserver.instance.memoryTotal
# - sqlserver.instance.memoryAvailable
# - sqlserver.instance.memoryUtilization
# - sqlserver.database.maxDiskSizeInBytes

# ✅ CLUSTERED/ALWAYS ON ENVIRONMENTS:
# - sqlserver.failover_cluster.log_bytes_received_per_sec
# - sqlserver.failover_cluster.transaction_delay_ms
# - sqlserver.failover_cluster.flow_control_time_ms
# - sqlserver.failover_cluster.replica.*
# - sqlserver.failover_cluster.availability_group.*
# - sqlserver.failover_cluster.redo_queue.* (Azure SQL Managed Instance)

# ✅ AUTHENTICATION METRICS (Available on all environments):
# - sqlserver.authentication.logins_per_sec
# - sqlserver.authentication.logouts_per_sec
# - sqlserver.authentication.failed_logins
# - sqlserver.authentication.total_activity

# ❌ LIMITED ON AZURE SQL DATABASE:
# - Some instance-level DMVs (Azure platform restrictions)
# - OS-level metrics (not available in PaaS)
# - Always On metrics (single database model)

# ❌ LIMITED ON AZURE SQL MANAGED INSTANCE:
# - Memory total/available/utilization metrics (restricted to Azure SQL Database)
# - Max disk size metrics (restricted to Azure SQL Database)

# =============================================================================
# TROUBLESHOOTING
# =============================================================================

# COMMON CONNECTION ISSUES:
# 1. "network is unreachable" - Check firewall rules, VNet connectivity
# 2. "login failed" - Verify username/password, check authentication method
# 3. "SSL required" - Set enable_ssl: true for Azure environments
# 4. "timeout" - Increase timeout value, check network latency

# ENVIRONMENT-SPECIFIC ISSUES:
# 1. Azure SQL Database: Verify firewall allows collector IP
# 2. Azure SQL Managed Instance: Check NSG rules, VNet connectivity
# 3. On-premises: Check Windows Firewall, SQL Server configuration

# METRIC COLLECTION ISSUES:
# 1. "no query available for engine edition" - Normal for environment-specific metrics
# 2. Missing metrics - Some metrics only work on specific SQL Server types
# 3. Permission errors - Ensure user has appropriate database permissions

# MONITORING:
# - Check collector logs for connection status and metric collection
# - Use debug exporter to see what metrics are being collected
# - Monitor New Relic for incoming metrics and any error conditions

# =============================================================================
# SECURITY NOTES
# =============================================================================

# 1. UPDATE CREDENTIALS: Replace example credentials with your actual values
# 2. USE ENVIRONMENT VARIABLES: In production, use env vars for sensitive data
# 3. SSL/TLS: Always enable SSL for production and Azure environments
# 4. LEAST PRIVILEGE: Use service accounts with minimal required permissions
# 5. NETWORK SECURITY: Ensure proper firewall and network segmentation
# 6. KEY ROTATION: Regularly rotate database passwords and API keys
