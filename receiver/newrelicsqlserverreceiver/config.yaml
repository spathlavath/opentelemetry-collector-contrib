# OpenTelemetry Collector Configuration
# Custom collector with New Relic SQL Server Receiver

# Extensions provide additional functionality

# Service configuration
service:
  # Enable extensions

  # Define the data pipeline
  pipelines:
    # Metrics pipeline: receiver -> processor -> exporter
    # All SQL Server data (including query performance, slow queries, active queries) collected as metrics
    metrics:
      receivers: [newrelicsqlserver]
      processors: [memory_limiter, batch]
      exporters: [otlphttp, debug]

  # Telemetry configuration for the collector itself
  telemetry:
    logs:
      level: debug  # Changed from info to debug for verbose logging
    metrics:
      level: none

# Processors transform and enrich the data
processors:
  # Memory limiter prevents out-of-memory issues
  memory_limiter:
    check_interval: 1s
    limit_mib: 256
    spike_limit_mib: 64

  # Batch processor groups data for efficient transmission
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Resource processor adds metadata to all telemetry
  # NOTE: server.address and server.port are automatically set by the receiver
  # based on the hostname and port configuration. No need to add them here.


# Receivers collect telemetry data
receivers:
  # Your New Relic SQL Server Receiver
  newrelicsqlserver:
    # SQL Server connection configuration
    # ⚠️  REPLACE THESE WITH YOUR ACTUAL VALUES ⚠️
    hostname: ""                    # e.g., "your-sql-server.com" or "192.168.1.100"
    port: "1433"                # Default SQL Server port
    username: ""              # e.g., "monitoring_user"
    password: ""              # Your SQL Server password
    monitored_databases: []


    # Optional: Named instance (if using SQL Server named instances)
    # instance: "${SQLSERVER_INSTANCE}"            # e.g., "SQLEXPRESS"

    # Query execution timeout (increased for slow queries on busy systems)
    timeout: 600s

    # Collection interval (how often to collect metrics)
    collection_interval: 60s

    # Lookback window for slow queries - should be >= collection_interval to avoid missing queries
    query_monitoring_fetch_interval: 60       # seconds - captures queries from last 60 seconds (matches collection_interval)

    # Optional: Initial delay before starting collection
    # initial_delay: 10s

    # Enable query performance monitoring (slow queries, active queries, execution plan stats as METRICS)
    enable_query_monitoring: true

    # Enable active running queries monitoring (captures currently executing queries with waits as METRICS)
    enable_active_running_queries: true

    # Query monitoring thresholds (required when enable_query_monitoring is true)
    query_monitoring_response_time_threshold: 0  # milliseconds - 0 = capture all queries (no threshold) for debugging
    query_monitoring_count_threshold: 100         # TopN: emit top 100 slowest queries per collection cycle
    query_monitoring_text_truncate_limit: 4094    # characters - maximum length of SQL text in query monitoring results (4KB - 2 bytes)

    # Active running queries configuration
    active_running_queries_elapsed_time_threshold: 0  # milliseconds - 0 = capture all active queries

    # Interval-based averaging (delta calculation) - EXPLICITLY ENABLED
    enable_interval_based_averaging: true          # Enable delta-based interval calculations
    interval_calculator_cache_ttl_minutes: 10      # Cache TTL for query state (10 minutes)

    # Database buffer metrics
    enable_database_buffer_metrics: true           # Enable database buffer pool metrics collection

    # Wait resource enrichment (adds human-readable names to wait resources)
    enable_wait_resource_enrichment: true          # Enable wait_resource name enrichment
    wait_resource_metadata_refresh_minutes: 5      # Metadata cache refresh interval

# Exporters send telemetry data to destinations
exporters:
  # New Relic OTLP HTTP Exporter
  otlphttp:
    # New Relic OTLP endpoint (HTTP uses port 4318, not 4317)
    endpoint: "https://staging-otlp.nr-data.net:4318"

    # Headers for authentication
    headers:
      # ⚠️  REPLACE WITH YOUR ACTUAL NEW RELIC LICENSE KEY ⚠️
      api-key: ""

    # TLS configuration
    tls:
      insecure: false

    # Retry configuration
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 300s

    # Queue configuration for handling bursts
    sending_queue:
      enabled: true
      num_consumers: 2
      queue_size: 100

    # Compression (gzip is recommended)
    compression: gzip

    # Timeout for HTTP requests
    timeout: 30s

  # Debug exporter for debugging (outputs to console)
  debug:
    verbosity: detailed
    # Output ALL metrics without sampling for troubleshooting
    sampling_initial: 10000  # Increased to capture more initial data
    sampling_thereafter: 10000  # Increased to see all metrics continuously

# Environment Variables to Set:
#
# Required:
# export SQLSERVER_HOST="your-sql-server-hostname-or-ip"
# export SQLSERVER_USERNAME="your-sql-username"
# export SQLSERVER_PASSWORD="your-sql-password"
# export NEW_RELIC_LICENSE_KEY="your-newrelic-license-key"
#
# Optional:
# export SQLSERVER_PORT="1433"
# export SQLSERVER_DATABASE="master"
# export SQLSERVER_INSTANCE="SQLEXPRESS"
#
# Example:
# export SQLSERVER_HOST="192.168.1.100"
# export SQLSERVER_USERNAME="monitoring_user"
# export SQLSERVER_PASSWORD="SecurePassword123!"
# export NEW_RELIC_LICENSE_KEY="eu01xxNRAL-your-actual-key-here"
#
# Then run:
# ./bin/otelcol-newrelic --config=config.yaml

# ============================================================================
# METRICS COLLECTED (All as OTLP Metrics)
# ============================================================================
#
# 1. DATABASE METRICS:
#    - Buffer pool metrics (size, hit ratio, pages)
#    - IO metrics (reads, writes, stalls)
#    - Transaction log metrics (flushes, growth, space usage)
#    - Database size metrics
#    - Memory metrics
#
# 2. INSTANCE METRICS:
#    - Memory metrics (total, available, target)
#    - CPU and process counts
#    - Connection metrics (active connections)
#    - Buffer pool metrics
#    - Disk metrics
#    - Lock metrics
#    - Index metrics
#
# 3. QUERY PERFORMANCE METRICS (when enable_query_monitoring: true):
#    - Slow query metrics (top N slowest queries)
#      * Query text (anonymized)
#      * Execution counts
#      * CPU time, elapsed time
#      * Logical reads/writes
#      * Row counts
#      * Query hash and plan handle
#
# 4. ACTIVE QUERY METRICS (when enable_active_running_queries: true):
#    - Currently executing queries
#      * Session ID, request ID, database
#      * Query text, command type, status
#      * Wait information (wait type, wait resource, enriched names)
#      * CPU time, elapsed time, reads/writes
#      * Blocking information
#
# 5. EXECUTION PLAN STATISTICS (as metrics):
#    - Plan handle, query hash correlation
#    - Creation time, last execution time
#    - Total elapsed time for plans
#    - Aggregated execution plan statistics
#
# 6. FAILOVER CLUSTER METRICS:
#    - Availability group health
#    - Replica status and synchronization
#    - Redo queue size
#
# 7. CONNECTION & AUTHENTICATION METRICS:
#    - User connection summary
#    - Connection utilization
#    - Login/logout statistics
#    - Failed login attempts
#
# 8. SECURITY METRICS:
#    - Database principals
#    - Security role members
#
# 9. WAIT TIME METRICS:
#    - Wait statistics by type
#    - Latch wait times
#
# 10. LOCK METRICS:
#     - Lock resource metrics
#     - Lock mode statistics
#
# 11. SYSTEM HEALTH METRICS:
#     - Thread pool health
#     - TempDB contention
#
# ============================================================================
# NOTES:
# ============================================================================
# - All data is collected as METRICS (no logs pipeline)
# - Execution plans are represented as aggregated statistics in metrics
# - No duplicate queries - everything collected in single scrape cycle
# - Query performance data includes slow queries + active queries
# - All metrics include rich resource attributes (hostname, port, database, etc.)
