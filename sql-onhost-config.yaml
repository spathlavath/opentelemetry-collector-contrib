receivers:
  # Host metrics receiver to collect system-level metrics
  # hostmetrics:
  #   collection_interval: 60s
  #   scrapers:
  #     # CPU metrics (usage, load)
  #     cpu:
  #       metrics:
  #         system.cpu.utilization:
  #           enabled: true
  #         system.cpu.physical.count:
  #           enabled: true
  #         system.cpu.logical.count:
  #           enabled: true

  #     # Memory metrics (available, used, utilization)
  #     memory:
  #       metrics:
  #         system.memory.usage:
  #           enabled: true
  #         system.memory.utilization:
  #           enabled: true

  #     # Disk I/O metrics
  #     disk:
  #       metrics:
  #         system.disk.io:
  #           enabled: true
  #         system.disk.operations:
  #           enabled: true
  #         system.disk.io_time:
  #           enabled: true

  #     # Filesystem metrics (disk space usage)
  #     filesystem:
  #       metrics:
  #         system.filesystem.usage:
  #           enabled: true
  #         system.filesystem.utilization:
  #           enabled: true
  #       exclude_mount_points:
  #         mount_points: ["/boot", "/dev", "/proc", "/sys", "/tmp"]
  #         match_type: strict
  #       exclude_fs_types:
  #         fs_types:
  #           [
  #             "autofs",
  #             "binfmt_misc",
  #             "bpf",
  #             "cgroup2",
  #             "configfs",
  #             "debugfs",
  #             "devpts",
  #             "devtmpfs",
  #             "fusectl",
  #             "hugetlbfs",
  #             "iso9660",
  #             "mqueue",
  #             "nsfs",
  #             "overlay",
  #             "proc",
  #             "procfs",
  #             "pstore",
  #             "rpc_pipefs",
  #             "securityfs",
  #             "selinuxfs",
  #             "squashfs",
  #             "sysfs",
  #             "tracefs",
  #           ]
  #         match_type: strict

  #     # Network I/O metrics
  #     network:
  #       metrics:
  #         system.network.io:
  #           enabled: true
  #         system.network.packets:
  #           enabled: true
  #         system.network.errors:
  #           enabled: true
  #         system.network.dropped:
  #           enabled: true

  #     # System load metrics (Linux/macOS)
  #     load:
  #       metrics:
  #         system.cpu.load_average.1m:
  #           enabled: true
  #         system.cpu.load_average.5m:
  #           enabled: true
  #         system.cpu.load_average.15m:
  #           enabled: true

  #     # Process metrics
  #     processes:
  #       metrics:
  #         system.processes.count:
  #           enabled: true
  #         system.processes.created:
  #           enabled: true

  newrelicsqlserver:
    # # Azure Windows VM connection details
    # hostname: "74.225.24.140"
    # port: "1433"
    # # Option 1: Windows domain authentication (if SQL Server is configured for it)
    # username: "pkudikyala-wind\\pkudikyala" # Windows domain authentication
    # password: "Pkudikyala@1991"

    hostname: "20.185.235.202" # Your Azure VM Public IP
    port: "1433" # Standard SQL Server port
    username: "otel_collector" # Dedicated service account
    password: "Admin@1234" # Service account password

    # Option 2: If above fails, try SQL Server authentication (create a SQL login first)
    # username: "sa" # or another SQL Server login
    # password: "YourSQLPassword"
    collection_interval: 60s
    timeout: 45s

    # TLS settings for secure connection
    enable_ssl: false # Set to true and configure certificates for production
    trust_server_certificate: true # Only for testing - use proper certs in production

    # =============================================================================
    # METRIC CONFIGURATION
    # =============================================================================
    # Explicitly enable all metrics to ensure they're collected

    # Core Database Sample Metrics
    enable_database_sample_metrics: true

    # Instance-level Metrics
    enable_instance_memory_metrics: true
    enable_instance_comprehensive_stats: true
    enable_instance_stats: true
    enable_instance_buffer_pool_hit_percent: true
    enable_instance_process_counts: true
    enable_instance_runnable_tasks: true
    enable_instance_disk_metrics: true
    enable_instance_active_connections: true
    enable_instance_buffer_pool_size: true
    enable_instance_target_memory_metrics: true
    enable_instance_performance_ratios_metrics: true
    enable_instance_index_metrics: true
    enable_instance_lock_metrics: true

    # Security Metrics
    enable_security_metrics: true
    enable_security_principals_metrics: true
    enable_security_role_members_metrics: true

    # Wait Time Metrics
    enable_latch_wait_time_metrics: true

    # Database Metrics
    enable_buffer_metrics: true
    enable_database_reserve_metrics: true
    enable_disk_metrics_in_bytes: true
    enable_io_metrics: true
    enable_log_growth_metrics: true
    enable_page_file_metrics: true
    enable_page_file_total_metrics: true
    enable_memory_metrics: true
    enable_memory_total_metrics: true
    enable_memory_available_metrics: true
    enable_memory_utilization_metrics: true

    # Database Security Metrics
    enable_database_principals_details_metrics: true
    enable_database_principals_summary_metrics: true
    enable_database_principals_activity_metrics: true

    # Database Role Membership Metrics
    enable_database_role_membership_details_metrics: true
    enable_database_role_membership_summary_metrics: true
    enable_database_role_hierarchy_metrics: true
    enable_database_role_activity_metrics: true
    enable_database_role_permission_matrix_metrics: true

    # Database Size and Transaction Log Metrics
    enable_database_size_metrics: true
    enable_database_transaction_log_metrics: true
    enable_database_log_space_usage_metrics: true

    # User Connection Metrics (re-enabled with selective configuration)
    enable_user_connection_status_metrics: true
    enable_user_connection_summary_metrics: true # This generates the metrics you need
    enable_user_connection_utilization_metrics: true
    enable_user_connection_client_metrics: false # Keep disabled to avoid timeout
    enable_user_connection_client_summary: true
    enable_user_connection_stats_metrics: true

    # Authentication and Failed Login Metrics (these should work without timeout issues)
    enable_failed_login_metrics: true
    enable_failed_login_summary_metrics: true

    # Failover Cluster Metrics (disable if not using Always On AGs)
    enable_failover_cluster_replica_metrics: true
    enable_failover_cluster_replica_state_metrics: true
    enable_failover_cluster_availability_group_health_metrics: true
    enable_failover_cluster_availability_group_metrics: true
    enable_failover_cluster_redo_queue_metrics: true

    # =============================================================================
    # QUERY MONITORING CONFIGURATION
    # =============================================================================
    enable_query_monitoring: true
    query_monitoring_response_time_threshold: 1000 # Monitor queries > 1000ms (1 second)
    query_monitoring_count_threshold: 10 # Monitor queries executed > 10 times
    query_monitoring_fetch_interval: 15 # Fetch query stats every 15 seconds
    query_monitoring_text_truncate_limit: 1000 # Truncate query text to 1000 characters

    # Concurrency settings
    max_concurrent_workers: 5

exporters:
  # New Relic OTLP exporter for staging
  otlphttp:
    endpoint: "https://staging-otlp.nr-data.net:4318"
    headers:
      api-key: "abc7b84730116eb478ad6b79719e4d64FFFFNRAL"
    compression: gzip
    timeout: 30s

  # Debug exporter to see what's being sent
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

processors:
  # Add resource attributes to identify the source
  resource:
    attributes:
      - key: service.name
        value: "azure-mssql-and-host-monitoring"
        action: upsert
      - key: service.version
        value: "1.0.0"
        action: upsert
      - key: deployment.environment
        value: "staging"
        action: upsert
      # - key: host.name
      #   value: "azure-windows-vm"
      # action: upsert
      - key: cloud.provider
        value: "azure"
        action: upsert
      - key: monitoring.type
        value: "sql-server-and-host"
        action: upsert

  # Batch metrics for efficiency
  batch:
    timeout: 5s
    send_batch_size: 100
    send_batch_max_size: 1000

service:
  telemetry:
    logs:
      level: debug # Enable debug logging to see what's happening
      development: true # Enable development mode for more verbose logging
    metrics:
      level: detailed

  pipelines:
    metrics:
      receivers: [newrelicsqlserver]
      processors: [resource, batch]
      exporters: [debug, otlphttp] # Put debug first to see all metrics

  extensions: []
