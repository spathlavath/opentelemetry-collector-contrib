# OpenTelemetry Collector Configuration for New Relic SQL Server Integration
# Configuration for Azure SQL Managed Instance with New Relic Staging Environment
# Optimized for Azure SQL Managed Instance (Engine Edition 8) specific features

# Extensions provide additional functionality
extensions:
  # Health check endpoint for monitoring collector health
  health_check:
    endpoint: localhost:13133

# Service configuration
service:
  # Enable extensions
  extensions: [health_check]

  # Define the data pipeline
  pipelines:
    # Metrics pipeline: receiver -> processor -> exporter
    metrics:
      receivers: [newrelicsqlserver]
      processors: [memory_limiter, batch, resource]
      exporters: [otlphttp, debug]

  # Telemetry configuration for the collector itself
  telemetry:
    logs:
      level: debug # Set to debug for troubleshooting
    metrics:
      level: none # Disable internal metrics to avoid port conflicts

# Processors transform and enrich the data
processors:
  # Memory limiter prevents out-of-memory issues
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Batch processor groups data for efficient transmission
  batch:
    timeout: 10s
    send_batch_size: 512
    send_batch_max_size: 1000

  # Resource processor adds metadata to all telemetry
  resource:
    attributes:
      - key: deployment.environment
        value: "staging"
        action: upsert
      - key: service.name
        value: "azure-sql-managed-instance-monitoring"
        action: upsert

# Receivers collect telemetry data
receivers:
  # New Relic SQL Server Receiver for Azure SQL Managed Instance
  newrelicsqlserver:
    # Azure SQL Managed Instance connection configuration
    # PRIVATE ENDPOINT (requires VPN or tunnel) - current configuration
    hostname: "pkudikyala-mi-node1.0a002db0321d.database.windows.net" # Private endpoint FQDN
    port: "1433" # Private endpoint port
    # PUBLIC ENDPOINT (if available) - uncomment to use instead
    # hostname: "pkudikyala-azure-managed-instance.public.e6b1e004d901.database.windows.net" # Public endpoint
    # port: "3342" # Public endpoint port (different from private port 1433)
    username: "pkudikyala" # Azure SQL Managed Instance username (without domain)
    password: "Praveenkudikyala@1991" # Azure SQL Managed Instance password

    # Collection interval (collect metrics every 30 seconds for testing)
    collection_interval: 30s

    # Connection timeout for Azure SQL Managed Instance connections
    timeout: 30s

    # Enable SSL for secure connection (required for Azure SQL Managed Instance)
    enable_ssl: true
    trust_server_certificate: false # Use proper certificate validation for Azure

    # =============================================================================
    # GRANULAR METRIC CONFIGURATION
    # =============================================================================
    # Core Database Sample Metrics
    enable_database_sample_metrics: true

    # Instance-level Metrics
    enable_instance_memory_metrics: true
    enable_instance_comprehensive_stats: true
    enable_instance_stats: true
    enable_instance_buffer_pool_hit_percent: true
    enable_instance_process_counts: true
    enable_instance_runnable_tasks: true
    enable_instance_disk_metrics: true
    enable_instance_active_connections: true
    enable_instance_buffer_pool_size: true
    enable_instance_target_memory_metrics: true
    enable_instance_performance_ratios_metrics: true
    enable_instance_index_metrics: true
    enable_instance_lock_metrics: true

    # Security Metrics
    enable_security_metrics: true
    enable_security_principals_metrics: true
    enable_security_role_members_metrics: true

    # Wait Time Metrics
    enable_latch_wait_time_metrics: true

    # Database Metrics
    enable_buffer_metrics: true
    enable_database_reserve_metrics: true
    enable_disk_metrics_in_bytes: true
    enable_io_metrics: true
    enable_log_growth_metrics: true
    enable_page_file_metrics: true
    enable_page_file_total_metrics: true
    enable_memory_metrics: true
    enable_memory_total_metrics: true
    enable_memory_available_metrics: true
    enable_memory_utilization_metrics: true

    # Database Security Metrics
    enable_database_principals_details_metrics: true
    enable_database_principals_summary_metrics: true
    enable_database_principals_activity_metrics: true

    # Database Role Membership Metrics
    enable_database_role_membership_details_metrics: true
    enable_database_role_membership_summary_metrics: true
    enable_database_role_hierarchy_metrics: true
    enable_database_role_activity_metrics: true
    enable_database_role_permission_matrix_metrics: true

    # Database Size and Transaction Log Metrics
    enable_database_size_metrics: true
    enable_database_transaction_log_metrics: true
    enable_database_log_space_usage_metrics: true

    # System Performance Metrics (our new metrics)
    enable_system_cpu_queue_metrics: true
    enable_system_memory_pages_metrics: true
    enable_system_disk_queue_metrics: true

    # User Connection Metrics (disabled due to timeout issues)
    enable_user_connection_status_metrics: true
    enable_user_connection_summary_metrics: true
    enable_user_connection_utilization_metrics: true
    enable_user_connection_client_metrics: true
    enable_user_connection_client_summary: true
    enable_user_connection_stats_metrics: true

    # Failover Cluster Metrics (disable if not using Always On AGs)
    enable_failover_cluster_replica_metrics: true
    enable_failover_cluster_replica_state_metrics: true
    enable_failover_cluster_availability_group_health_metrics: true
    enable_failover_cluster_availability_group_metrics: true
    enable_failover_cluster_redo_queue_metrics: true

    # =============================================================================
    # QUERY MONITORING CONFIGURATION
    # =============================================================================
    enable_query_monitoring: true
    query_monitoring_response_time_threshold: 1000 # Monitor queries > 1000ms (1 second)
    query_monitoring_count_threshold: 10 # Monitor queries executed > 10 times
    query_monitoring_fetch_interval: 15 # Fetch query stats every 15 seconds
    query_monitoring_text_truncate_limit: 1024 # Truncate query text to 1024 characters

    # Concurrency settings
    max_concurrent_workers: 5

# Exporters send telemetry data to destinations
exporters:
  # New Relic OTLP HTTP Exporter for Staging Environment
  otlphttp:
    # New Relic Staging OTLP endpoint (using HTTPS on port 4318)
    endpoint: "https://staging-otlp.nr-data.net:4318"

    # Headers for New Relic authentication
    headers:
      # New Relic License Key for staging environment
      api-key: "abc7b84730116eb478ad6b79719e4d64FFFFNRAL"

    # TLS configuration for HTTPS
    tls:
      insecure: false
      insecure_skip_verify: false

    # Retry configuration for robust delivery
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 300s
      randomization_factor: 0.5

    # Queue configuration for handling traffic bursts
    sending_queue:
      enabled: true
      num_consumers: 4
      queue_size: 200

    # Enable gzip compression for better performance
    compression: gzip

    # HTTP request timeout
    timeout: 30s

  # Debug exporter for local troubleshooting
  debug:
    verbosity: detailed
    # Show first 5 metrics then every 100th for debugging
    sampling_initial: 5
    sampling_thereafter: 100
# Notes for Azure SQL Managed Instance Usage:
#
# 1. IMPORTANT: Update connection details before using:
#    - hostname: Replace "your-managed-instance.database.windows.net" with your Azure SQL Managed Instance server
#    - username: Replace "your-managed-instance-username" with your Azure SQL Managed Instance user
#    - password: Replace "your-managed-instance-password" with your Azure SQL Managed Instance password
#
# 2. Azure SQL Managed Instance Specific Features:
#    - Engine Edition 8 (Azure SQL Managed Instance)
#    - SSL/TLS encryption is REQUIRED and enabled
#    - Uses Azure SQL Managed Instance specific queries for optimal performance
#    - More DMVs available compared to Azure SQL Database
#    - Multi-database support (unlike Azure SQL Database)
#    - Memory metrics are NOT available (restricted to Azure SQL Database only)
#    - Max disk size metrics are NOT available (restricted to Azure SQL Database only)
#
# 3. Metrics Available for Azure SQL Managed Instance:
#    ✅ Buffer Pool Metrics (sqlserver.database.buffer_pool_size)
#    ✅ I/O Stall Metrics (sqlserver.database.io_stall)
#    ✅ Log Growth Metrics (sqlserver.database.log_growth)
#    ✅ Page File Metrics (sqlserver.database.page_file_available/total)
#    ❌ Memory Metrics (sqlserver.database_memory_metrics) - AZURE SQL DATABASE ONLY
#    ❌ Max Disk Size Metrics (sqlserver.database.max_disk_size) - AZURE SQL DATABASE ONLY
#
# 4. Metrics NOT Available for Azure SQL Managed Instance:
#    ❌ Memory metrics (restricted to Azure SQL Database only)
#    ❌ Max disk size metrics (restricted to Azure SQL Database only)
#    ❌ Some OS-level instance metrics (Azure limitation, but more available than Azure SQL Database)
#
# 5. Engine-Specific Behavior:
#    - The collector automatically detects engine edition 8 (Azure SQL Managed Instance)
#    - Memory and max disk size metrics are automatically skipped for Managed Instance
#    - Uses Managed Instance specific queries for I/O, log growth, and page file metrics
#    - Supports multiple databases per instance (unlike Azure SQL Database)
#
# To run this configuration:
# ./bin/otelcontribcol_darwin_arm64 --config=azure-sql-managed-instance-config.yaml
#
# Expected Azure SQL Managed Instance Metrics (with gauge type and statistical attributes):
# - sqlserver.database.buffer_pool_size (count, sum, min, max, avg, latest)
# - sqlserver.database.io_stall (count, sum, min, max, avg, latest)
# - sqlserver.database.log_growth (count, sum, min, max, avg, latest)
# - sqlserver.database.page_file_available (count, sum, min, max, avg, latest)
# - sqlserver.database.page_file_total (count, sum, min, max, avg, latest)
#
# Metrics NOT collected for Azure SQL Managed Instance:
# - sqlserver.database_memory_metrics (Azure SQL Database only)
# - sqlserver.database.max_disk_size (Azure SQL Database only)
#
# Configuration Options:
# Option 1 - Master Toggle (Simplified, Recommended):
#   enable_database_sample_metrics: true
#
# Option 2 - Granular Control (Individual flags when master toggle is false):
#   enable_database_sample_metrics: false
#   enable_buffer_metrics: true
#   # NOTE: Memory and max disk size flags won't work for Managed Instance
#
# Azure SQL Managed Instance Connection Examples:
#
# Example 1 - Standard Azure SQL Managed Instance:
# hostname: "my-managed-instance.a1b2c3d4e5f6.database.windows.net"
# username: "sqladmin"
# password: "MyComplexPassword123!"
#
# Example 2 - Azure SQL Managed Instance with custom port:
# hostname: "my-managed-instance.a1b2c3d4e5f6.database.windows.net"
# port: "1433"
# username: "sqladmin"
# password: "MyComplexPassword123!"
#
# Monitor the logs for:
# - Successful Azure SQL Managed Instance connection (should show engine edition 8)
# - Master toggle enabling supported database metrics
# - Managed Instance-specific queries being used
# - SSL/TLS connection establishment
# - Memory and max disk size metrics being skipped (expected behavior)
# - Metrics being scraped and exported to New Relic
# - Any authentication or network issues
#
# Security Notes:
# - This config contains sensitive credentials - update before use
# - SSL/TLS is REQUIRED for Azure SQL Managed Instance and is enabled
# - In production, use Azure Key Vault or environment variables
# - Ensure Azure SQL Managed Instance NSG allows collector's IP address
# - Consider using Azure AD authentication for enhanced security
# - Managed Instance supports more advanced authentication methods than Azure SQL Database
#
# Troubleshooting Azure SQL Managed Instance:
# - Verify server name format: "managed-instance-name.dns-zone.database.windows.net"
# - Check Azure SQL Managed Instance NSG (Network Security Group) rules
# - Ensure SSL is enabled (required for Azure SQL Managed Instance)
# - Verify Azure SQL Managed Instance service tier supports required features
# - Check that username doesn't include domain prefix (Azure SQL Managed Instance specific)
# - Verify virtual network connectivity if using private endpoints
# - Check if any custom DNS settings affect name resolution
#
# NETWORK CONNECTIVITY TROUBLESHOOTING:
#
# Error: "dial tcp 10.0.0.x:1433: connect: network is unreachable"
# Solution: This indicates your Managed Instance uses a private endpoint (private IP).
#
# Fix Options:
# 1. Use Public Endpoint (if enabled):
#    - hostname: "your-instance.public.dns-zone.database.windows.net"
#    - port: "3342" (public endpoint uses different port)
#    - Ensure public endpoint is enabled in Azure portal
#    - Configure firewall to allow your IP address
#
# 2. Use VPN/ExpressRoute Connection:
#    - Connect to the same virtual network as the Managed Instance
#    - Use private endpoint hostname with port 1433
#    - Ensure proper routing and NSG rules
#
# 3. Azure Bastion/Jump Server:
#    - Deploy collector on VM in the same VNet
#    - Use private endpoint hostname with port 1433
#
# To check if public endpoint is available:
# - Go to Azure Portal > SQL Managed Instance > Networking
# - Check "Public endpoint" section
# - If enabled, use format: instance-name.public.dns-zone.database.windows.net:3342
#
# DNS Resolution Test:
# Run: nslookup pkudikyala-azure-managed-instance.e6b1e004d901.database.windows.net
# If it returns 10.x.x.x IP = Private endpoint (needs VPN/VNet access)
# If it returns public IP = Accessible from internet
#
# Azure SQL Managed Instance vs Azure SQL Database:
# - Managed Instance: Multi-database support, more DMVs, no memory/max disk size metrics
# - SQL Database: Single database, limited DMVs, memory/max disk size metrics available
# - Both require SSL/TLS encryption
# - Both use Azure-specific query variants for optimal performance
